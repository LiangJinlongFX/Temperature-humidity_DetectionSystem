# Temperature-humidity_DetectionSystem
2018通信工程课程设计


###硬件部分

+ STC89C51单片机最小系统
+ DHT11传感器外围电路设计
+ LCD1602显示屏外围电路设计
+ ESP8266外围电路设计
+ 继电器控制电路设计
+ 其他电路设计

*要点：*

+ *利用Altium Designer 绘制相应的原理图*
+ *协商硬件接口定义*
+ *理解单片机及外围电路原理*

### APP开发工程师职责

+ 登录页面设计
  + wifi热点登录信息录入及校验
  + 确保登录信息的准确性及纠错冗余
+ 数据存储/查询页面设计
  + 从wifi模块接收到的传感器信息存储到手机本地创建的数据文本中
+ 传感器数据查看及开关反向控制界面设计
  + 接收从wifi模块传过来的传感器信息，并提取有效数据显示出来
  + 设计按钮，及时将开关信息传送到wifi模块中
+ 与系统工程师协商数据传输格式

*要点：*

+ *熟悉APP Inventor2 的使用流程*
+ 熟悉APP原型执行流程
+ 了解TCP通信流程
+ 熟悉自定义的数据传输格式

### 物联网工程师职责

+ 配置ESP8266工作模式、设置串口、默认连接信息
+ 利用花生壳进行内网穿透
+ 了解数据传输流程

*要点：*

+ 了解ESP8266基本原理
+ 熟悉AT指令
+ 使用ESP8266建立TCPServer
+ 了解花生壳
+ 熟悉8266的串口数据发送/接收格式

### 电路板焊接

+ 熟悉课设要用到的元器件
+ 熟悉焊接电路板的基本操作/技巧

### 驱动开发

+ 了解DHT11单总线协议
+ 了解LCD1602
+ 看芯片 datasheet
+ 接口定义

###TCP socket  数据交互格式

+ 采用client突发请求，server响应的交互通信模式

+ 通信流程

  1. client成功连接上TCPserver
  2. client发送请求描述符
  3. server接收到client的请求描述指令后，根据请求描述符提取需发送的数据类型【温湿度/开关信息】
  4. server将有效数据封装成响应格式包后发送给client
  5. client解封响应包以提取有效数据

+ 请求描述符

  前导码 + 请求数据类型 + 校验码

  ~~~c
  0x88 0x88 0x88 0x00(温湿度信息)/0x01(开关开)/0x02(开关关)/0x03(当前开关状态)] + 校验码[0x88 + 请求数据类型]
  ~~~

+ 响应信息包格式

  前导码 + 有效负载 + 校验码

  + 温湿度信息

    ~~~c
    0x88 0x88 0x88 <湿度整数位> <湿度小数位> <温度整数位> <温度小数位> <校验位>  //参考DHT11数据格式
    ~~~

  + 开关信息

    ~~~c
    0x88 0x88 0x88 <当前开关状态> <校验位>
    ~~~

+ 说明

  - server不用理会当前有多少个client连接了，交互情况由client确定。当然，server应设置超时机制，把长时间只连接不交互的client踢掉

  - ESP8266接收APP的数据格式应为：+IPD,y,n:xxxx

    这样我们就知道编号为y的client往8266发送数据了，同时也知道数据包的大小为n

    单片机提取这些有效数据后就能准确地利用指令：AT+CIPSEND=y,4  进行响应了

  - 根据实际情况可去掉数据包的前导码&校验位部分

  - 连接状态显示/故障处理由手机APP端处理

## E4A避坑说明

+ 窗体命名命令不能用main

### ESP8266AT指令

+ ESP8266出厂波特率为76800，使用时应将起改为115200

~~~shell
//务必关闭指令回显功能，否则指令回显会干扰单片机接收数据，造成两次请求才能触发一次响应
ATE0	//开关回显功能
AT+CWMODE_DEF=1	//设置默认为station模式
AT+CWSAP_DEF="ESP8266_FX","1234567890",5,3	//设置默认热点信息
AT+UART_DEF=9600,8,1,0,0	//设置默认串口参数
AT+CIPAP_DEF="192.168.66.1","192.168.66.1","255.255.255.0" //设置默认IP地址
AT+CWDHCP_DEF=0,1	//设置softAP模式开启DHCP功能
AT+CWDHCPS_DEF=1,5,"192.168.66.10","192.168.66.30"	//设置DHCP分配地址范围
AT+CIPMUX=1 //使能多连接
AT+CIPSERVER=1,8000 //启动TCP服务器
AT+CIPSTO=600	//设置超时

AT+CWDHCPS_CUR? //查询DHCP信息
AT+CWSAP?	//查询AP信息
AT+CIFSR	//查询本地IP地址
~~~



### 说明

+ 注意将编译器优化级别调到最高，否则软件延时不准
